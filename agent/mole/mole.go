// mole is tunnel maker package.
// Mole is a craftsman and makes full featured wireguard tunnels.
// Actually all tunnel and peer configuration should go through this package.
// wireguard, router and netfilter packages are apprentices to help mole.
package mole

import (
	"fmt"
	"io"
	"sync"

	"github.com/SyntropyNet/syntropy-agent/agent/hostroute"
	"github.com/SyntropyNet/syntropy-agent/agent/mole/ctrlmgr"
	"github.com/SyntropyNet/syntropy-agent/agent/mole/ipfilter"
	"github.com/SyntropyNet/syntropy-agent/agent/mole/peercache"
	"github.com/SyntropyNet/syntropy-agent/agent/router"
	"github.com/SyntropyNet/syntropy-agent/agent/swireguard"
)

const (
	pkgName = "Mole."
)

type Mole struct {
	sync.Mutex
	writer               io.Writer
	wg                   *swireguard.Wireguard
	router               *router.Router
	filter               *ipfilter.PacketFilter
	hostRoute            *hostroute.HostRouter
	peers                *peercache.PeerCache
	controllerHostRoutes ctrlmgr.ControllerHostRouteManager
}

func New(w io.Writer) (*Mole, error) {
	var err error
	m := &Mole{
		writer:    w,
		router:    router.New(w),
		hostRoute: &hostroute.HostRouter{},
		peers:     peercache.New(),
	}
	err = m.hostRoute.Init()
	if err != nil {
		return nil, fmt.Errorf("host route: %s", err)
	}

	m.wg, err = swireguard.New()
	if err != nil {
		return nil, fmt.Errorf("wireguard: %s", err)
	}

	m.filter, err = ipfilter.New()
	if err != nil {
		return nil, fmt.Errorf("ipfilter: %s", err)
	}

	err = m.controllerHostRoutes.Init()
	if err != nil {
		return nil, fmt.Errorf("controller routes (VPN client): %s", err)
	}

	return m, nil
}

/*;::::::;:::;:::::::;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
,,,,................................................................................................
,,,,................................................................................................
,,,,................................................................................................
,,,,................................................................................................
,,,,................................................................................................
,,,,...................................................:.....:,.....................................
,,,,...............................................,:..+,...+:......................................
,,,,................................................+,.+;..++.......................................
,,,,...................,,,..........................:*.:?.,?........................................
,,,,..................:+;;+;,........................?+.%:*;.........................:;;;...........
,,,,..................;+,,,:++,......................;#*?%S%S#%*%*;,................;*::?,.,:,......
,,,,.............,;;;;:;+:,,,;*:,,:,.............,;?#@#%@@%?%@@@%*?%*,......,;;;:..;+,,+;:+;;*,.....
,,,,.............+*,::;++?:,,,:?*;:?,..........,*#@@@@%@@:...:SS..,,*#;.,:;;**::*+;+,,+*;;:,;+......
,,,,.............,++::,,::,,,,:%:,;;..........:S@@@@@@#@S..:#;,?.,@%.*@?***%:++,,*;,,,;::,:++,......
,,,,...............,:;;;,,,,,:+*,:*,.........,#@@@@@@@@@@:.,SS.;+.+%:*##***?..+;,;+;,,,,,++:........
,,,,...........,;;;;;;;;,,,,;*:,,:*..........+@@@@@@@@@@@%;;;+;:#*+%@@@@?+?+..++,,,*:,,,,;;;;;;*:...
,,,,...........,?::::::::,,,;;,,,,+;.........%@@@@@@@@@@*;;;*;;?@@@@#%*;+%*...*:,,:*:,,,,:::::++,...
,,,,............,:;;;;:+;,,,,:,,,+#@?:,......%@@@@@@@@@*:::;%?;:+*+;;::;%*..,*%:,,::,,,,;*;;;;:.....
,,,,...................,*:,,,,,,*@@@@@#%+:,..?@@@@@@@@@;:;;:*@#%*++++?S@@+:?#@@@*,,,,,:++,..........
,,,,....................:++;:::+@@@@@@@@@@#S?S@@@@@@@@#;:;;:;@@@#++++#@@@#@@@@@@@*,:;+*:............
,,,,......................,::;;%@@@@@@@@@@@@@@@@@@@@@@@+:;;;:?@@?:::;@@@@#@@@@@@@@+;;:..............
,,,,............................:*%@@@@@@@@@@@@@@@@@@@@*:;;;;;+*;;;:;@@@@S@@@@@@S*,.................
,,,,...............................,;*S#@@@@@@@@@@@@@@@?:;;;;**+;;;:;#@@@#@@@S*:....................
,,,,...................................,:+?#@@@@@@@@@@@?:;;;;:;;;;;;:S@@@@S*:.......................
,,,,.......................................%@@@@@@@@@@@*:;;;;;;;;;;;:*@@@@*.........................
,,,,......................................:@@@@@@@@@@@@+:;;;;;;;;;;;:;@@@@@,........................
,,,,......................................*@@@@@@@@@@@@;:;;;;;;;;;;;;:S@@@@*........................
,,,,......................................#@@@@@@@@@@@#;;;;;;;;;;;;;;:*@@@@%........................
,,,,.....................................:@@@@@@@@@@@@%:;;;;;;;;;;;;;:+@@@@#,.......................
,,,,.....................................:@@@@@@@@@@@@?:;;;;;;;;;;;;;:;@@@@#,.......................
,,,,.....................................:@@@@@@@@@@@@?:;;;;;;;;;;;;;:;@@@@S........................
,,,,.....................................,#@@@@@@@@@@@S:;;;;;;;;;;;;;:+@@@@*........................
,,,,......................................+@@@@@@@@@@@@*::;;;;;;;;;;::S@@@#,........................
,,,,.......................................*@@@@@@@@@@@@?;::::::::::+S@@@@;.........................
,,,,........................................+#@@@@@@@@@@@@S?*+++++?S@@@@S:..........................
,,,,.........................................,*#@@@@@@@@@@@@@@@@@@@#%%%%+,..........................
,,,,...................................,;;,....:*#@%*;;;;*S@@@@@@%;:,,,:;*+..,;;,...................
,,,,...............................,::;+??+;;:;%*+?+**+++++*?????*+**+*****;;+??;:;,................
,,,,...........................,:::+**++;++++++++++*%%*++;;;++++++*%?+++;;;+*++++*%+................
,,,,...........................+%?+*S%+++++;++++++;;++++++++?%++;;++++++++++++;;;++,................
,,,,...........................,++++**+??+++++++++;;+*++;;++**++++++;;;+*%*++++++?%;,,..............
,,,,..........................,;?%*+;+++++++++++++++?%*++++++++++*S?+++++*+;;+++++*+*%*,..........*/
