// mole is tunnel maker package.
// Mole is a craftsman and makes full featured wireguard tunnels.
// Actually all tunnel and peer configuration should go through this package.
// wireguard, router and netfilter packages are apprentices to help mole.
package mole

import (
	"io"

	"github.com/SyntropyNet/syntropy-agent/agent/router"
	"github.com/SyntropyNet/syntropy-agent/agent/swireguard"
)

const (
	pkgName = "Mole."
)

type Mole struct {
	writer io.Writer
	wg     *swireguard.Wireguard
	router *router.Router
	cache  map[string]entry
}

func New(w io.Writer) (*Mole, error) {
	var err error
	m := &Mole{
		writer: w,
		router: router.New(w),
		cache:  make(map[string]entry),
	}
	m.wg, err = swireguard.New()
	if err != nil {
		return nil, err
	}
	return m, nil
}

/*;::::::;:::;:::::::;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
,,,,................................................................................................
,,,,................................................................................................
,,,,................................................................................................
,,,,................................................................................................
,,,,................................................................................................
,,,,...................................................:.....:,.....................................
,,,,...............................................,:..+,...+:......................................
,,,,................................................+,.+;..++.......................................
,,,,...................,,,..........................:*.:?.,?........................................
,,,,..................:+;;+;,........................?+.%:*;.........................:;;;...........
,,,,..................;+,,,:++,......................;#*?%S%S#%*%*;,................;*::?,.,:,......
,,,,.............,;;;;:;+:,,,;*:,,:,.............,;?#@#%@@%?%@@@%*?%*,......,;;;:..;+,,+;:+;;*,.....
,,,,.............+*,::;++?:,,,:?*;:?,..........,*#@@@@%@@:...:SS..,,*#;.,:;;**::*+;+,,+*;;:,;+......
,,,,.............,++::,,::,,,,:%:,;;..........:S@@@@@@#@S..:#;,?.,@%.*@?***%:++,,*;,,,;::,:++,......
,,,,...............,:;;;,,,,,:+*,:*,.........,#@@@@@@@@@@:.,SS.;+.+%:*##***?..+;,;+;,,,,,++:........
,,,,...........,;;;;;;;;,,,,;*:,,:*..........+@@@@@@@@@@@%;;;+;:#*+%@@@@?+?+..++,,,*:,,,,;;;;;;*:...
,,,,...........,?::::::::,,,;;,,,,+;.........%@@@@@@@@@@*;;;*;;?@@@@#%*;+%*...*:,,:*:,,,,:::::++,...
,,,,............,:;;;;:+;,,,,:,,,+#@?:,......%@@@@@@@@@*:::;%?;:+*+;;::;%*..,*%:,,::,,,,;*;;;;:.....
,,,,...................,*:,,,,,,*@@@@@#%+:,..?@@@@@@@@@;:;;:*@#%*++++?S@@+:?#@@@*,,,,,:++,..........
,,,,....................:++;:::+@@@@@@@@@@#S?S@@@@@@@@#;:;;:;@@@#++++#@@@#@@@@@@@*,:;+*:............
,,,,......................,::;;%@@@@@@@@@@@@@@@@@@@@@@@+:;;;:?@@?:::;@@@@#@@@@@@@@+;;:..............
,,,,............................:*%@@@@@@@@@@@@@@@@@@@@*:;;;;;+*;;;:;@@@@S@@@@@@S*,.................
,,,,...............................,;*S#@@@@@@@@@@@@@@@?:;;;;**+;;;:;#@@@#@@@S*:....................
,,,,...................................,:+?#@@@@@@@@@@@?:;;;;:;;;;;;:S@@@@S*:.......................
,,,,.......................................%@@@@@@@@@@@*:;;;;;;;;;;;:*@@@@*.........................
,,,,......................................:@@@@@@@@@@@@+:;;;;;;;;;;;:;@@@@@,........................
,,,,......................................*@@@@@@@@@@@@;:;;;;;;;;;;;;:S@@@@*........................
,,,,......................................#@@@@@@@@@@@#;;;;;;;;;;;;;;:*@@@@%........................
,,,,.....................................:@@@@@@@@@@@@%:;;;;;;;;;;;;;:+@@@@#,.......................
,,,,.....................................:@@@@@@@@@@@@?:;;;;;;;;;;;;;:;@@@@#,.......................
,,,,.....................................:@@@@@@@@@@@@?:;;;;;;;;;;;;;:;@@@@S........................
,,,,.....................................,#@@@@@@@@@@@S:;;;;;;;;;;;;;:+@@@@*........................
,,,,......................................+@@@@@@@@@@@@*::;;;;;;;;;;::S@@@#,........................
,,,,.......................................*@@@@@@@@@@@@?;::::::::::+S@@@@;.........................
,,,,........................................+#@@@@@@@@@@@@S?*+++++?S@@@@S:..........................
,,,,.........................................,*#@@@@@@@@@@@@@@@@@@@#%%%%+,..........................
,,,,...................................,;;,....:*#@%*;;;;*S@@@@@@%;:,,,:;*+..,;;,...................
,,,,...............................,::;+??+;;:;%*+?+**+++++*?????*+**+*****;;+??;:;,................
,,,,...........................,:::+**++;++++++++++*%%*++;;;++++++*%?+++;;;+*++++*%+................
,,,,...........................+%?+*S%+++++;++++++;;++++++++?%++;;++++++++++++;;;++,................
,,,,...........................,++++**+??+++++++++;;+*++;;++**++++++;;;+*%*++++++?%;,,..............
,,,,..........................,;?%*+;+++++++++++++++?%*++++++++++*S?+++++*+;;+++++*+*%*,..........*/
